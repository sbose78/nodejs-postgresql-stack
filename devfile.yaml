schemaVersion: 2.0.0
metadata:
  name: nodejs-postgres
projects:
  - name: nodejs-sbose78-postgres
    git:
      location: https://github.com/sbose78/nodejs-rest-http-crud
      branch: app-stak
  - name: nodes-postgres
    git:
      location: https://github.com/nodeshift-starters/nodejs-rest-http-crud
      branch: master
components:
  - chePlugin:
      registryEntry:
        id: che-incubator/typescript/latest
  - chePlugin:
      registryEntry:
        id: redhat/dependency-analytics/latest
  - container:
      name: nodejs
      image: quay.io/eclipse/che-nodejs10-ubi:nightly
      memoryLimit: 512Mi
      endpoints:
        - name: 'nodejs'
          port: 3000
      mountSources: true

commands:
  - exec:
      id: build 
      component: nodejs
      commandLine: npm install
      workdir: '${PROJECTS_ROOT}/nodejs-rest-http-crud'
  - exec:
      id: build 
      component: nodejs
      commandLine: nodemon app.js
      workdir: '${PROJECTS_ROOT}/nodejs-rest-http-crud'

images:
  - name: nodejs-crud
    strategy:
      name: Kaniko
    Dockerfile: '${STACK_ROOT}/Dockerfile'

workloads:
  dependencies:
    - description: Mongo DB deployment
      manifests: 
        - ${STACK_ROOT}/dependencies/postgres.yaml
  components:
    - description: NodeJS App built from source
      imageRef : nodejs-crud
      podTemplate:
        containers:
          - env:
              - name: DB_USERNAME
                valueFrom:
                  secretKeyRef:
                    name: database-secret
                    key: user
              - name: DB_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: database-secret
                    key: password
            readinessProbe:
              httpGet: ""
              path: /api/health/readiness
              port: 8080
              scheme: HTTP 
            livenessProbe:
              httpGet: ""
              path: /api/health/liveness
              port: 8080
              scheme: HTTP
